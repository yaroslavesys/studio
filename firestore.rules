rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    match /users/{userId} {
      // Admins can list all users.
      allow list: if isSignedIn() && request.auth.token.role == 'Admin';
      // Users can only read their own profile, Admins can read any.
      allow get: if isSignedIn() && (isOwner(userId) || request.auth.token.role == 'Admin');
      // New users can create their own profile. Admin can update any profile. Owner can update their own.
      allow write: if isSignedIn() && ((request.method == 'create' && isOwner(userId)) || request.auth.token.role == 'Admin' || (isOwner(userId) && request.method != 'create'));
    }

    // Departments are public for authenticated users. Only Admins can modify them.
    match /departments/{departmentId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.token.role == 'Admin';
    }

    // Access Requests
    match /accessRequests/{accessRequestId} {
      // Create: Any authenticated user can create a request for themselves.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // Get: Users can read their own requests. TechLeads can read requests for their department. Admins can read all.
      allow get: if isSignedIn() && 
                    (resource.data.userId == request.auth.uid || 
                     request.auth.token.role == 'Admin' ||
                     (request.auth.token.role == 'TechLead' && resource.data.departmentId == request.auth.token.departmentId));

      // List: Only Admins can list all requests.
      allow list: if isSignedIn() && request.auth.token.role == 'Admin';
      
      // Update: 
      // - Owners can't update.
      // - TechLeads can update status for their department's requests.
      // - Admins can update any request.
      allow update: if isSignedIn() && 
                      (request.auth.token.role == 'Admin' ||
                      (request.auth.token.role == 'TechLead' && request.resource.data.departmentId == request.auth.token.departmentId));
                      
      // Delete: Only admins can delete requests.
      allow delete: if isSignedIn() && request.auth.token.role == 'Admin';
    }
  }
}
