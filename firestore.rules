rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isRole(role) {
      return isSignedIn() && getUserData().role == role;
    }
    
    function isTechLeadOfDepartment(departmentId) {
        return isRole('TechLead') && getUserData().departmentId == departmentId;
    }

    match /users/{userId} {
      // Admins can list all users.
      allow list: if isRole('Admin');
      // Users can only read their own profile, Admins can read any.
      allow get: if isSignedIn() && (isOwner(userId) || isRole('Admin'));
      // New users can create their own profile. Admin can update any profile. Owner can update their own.
      allow write: if isSignedIn() && ((request.method == 'create' && isOwner(userId)) || isRole('Admin') || (isOwner(userId) && request.method != 'create'));
    }

    // Departments are public for authenticated users. Only Admins can modify them.
    match /departments/{departmentId} {
      allow read: if isSignedIn();
      allow write: if isRole('Admin');
    }

    // Access Requests
    match /accessRequests/{accessRequestId} {
      // Create: Any authenticated user can create a request for themselves.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // Get: Users can read their own requests. TechLeads can read requests for their department. Admins can read all.
      allow get: if isSignedIn() && 
                    (resource.data.userId == request.auth.uid || 
                     isRole('Admin') ||
                     isTechLeadOfDepartment(resource.data.departmentId));

      // List: Only Admins can list all requests. TechLeads and Users cannot.
      allow list: if isRole('Admin');
      
      // Update: 
      // - Owners can't update.
      // - TechLeads can update status for their department's requests.
      // - Admins can update any request.
      allow update: if isSignedIn() && 
                      (isRole('Admin') ||
                      isTechLeadOfDepartment(request.resource.data.departmentId));
                      
      // Delete: Only admins can delete requests.
      allow delete: if isRole('Admin');
    }
  }
}
